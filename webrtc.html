<!DOCTYPE html>
<html>

<head></head>

<body>
    <pre id="output"></pre>
    <script>
        function WebRTCConnection(role) {
            const configuration = {'iceServers': [{'urls': 'stun:stun.l.google.com:19302'}]};
            this.connection = new RTCPeerConnection(configuration);
            
            this.onAddIceCandidate = async (event) => {
                if (event.candidate != null)
                {
                    console.log(`icecandidate: ${JSON.stringify(event.candidate.toJSON())}`);
                }
            };
            this.connection.onicecandidate = this.onAddIceCandidate;

            this.onChannelStateChange = () => {
                const readyState = this.channel.readyState;
                console.log('Channel state is: ' + readyState);
            }
            this.onChannelMessageCallback = (event) => {
                console.log('Received Message: ' + event.data);
            }

            this.addIceCandidate = async (candidate) => {
                try {
                    this.connection.addIceCandidate(candidate);
                } catch {
                    console.log("Failed to add candidate");
                }
            }
            this.sendData = (data) => {
                this.channel.send(data);
                console.log('Sent Data: ' + data);
            }

            if (role == 'host')
            {
                this.channel = this.connection.createDataChannel('sendDataChannel');
                this.channel.onmessage = this.onChannelMessageCallback;
                this.channel.onopen = this.onChannelStateChange;
                this.channel.onclose = this.onChannelStateChange;

                this.connectToGuest = async (answer) => {
                    this.connection.setRemoteDescription(answer);
                }

                const createOffer = async () => {
                    const offer = await this.connection.createOffer();
                    this.connection.setLocalDescription(offer);
                    console.log(`offer: ${JSON.stringify(offer)}`);
                }
                createOffer();
            }
            else if (role == 'guest')
            {
                this.channelCallback = (event) => {
                    console.log('Receive Channel Callback');
                    this.channel = event.channel;
                    this.channel.onmessage = this.onChannelMessageCallback;
                    this.channel.onopen = this.onChannelStateChange;
                    this.channel.onclose = this.onChannelStateChange;
                }
                this.connection.ondatachannel = this.channelCallback;

                this.connectToHost = async (offer) => {
                    this.connection.setRemoteDescription(offer);
                    const answer = await this.connection.createAnswer();
                    this.connection.setLocalDescription(answer);
                    console.log(`answer: ${JSON.stringify(answer)}`);
                };
            }
        }
    </script>
</body>

</html>